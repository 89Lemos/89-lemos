<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vortex Temporal - Aurora Fullscreen</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #000; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; width: 100vw; touch-action: none; font-family: 'Courier New', Courier, monospace; }
        #gameCanvas { background-color: #000510; display: block; max-width: 100%; max-height: 100%; image-rendering: pixelated; }
    </style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = 400; canvas.height = 700;

const bgMusic = new Audio('https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3');
bgMusic.loop = true; bgMusic.volume = 0.3;
const explosionSound = new Audio('https://www.soundjay.com/buttons/sounds/button-10.mp3'); 

const MENU = 0, PLAYING = 1, GAMEOVER = 2, PAUSED = 3;
let gameState = MENU;
let meters = 0, exterminatedCount = 0, totalPoints = 0, difficulty = 1.0;
let particles = [], daleks = [], lasers = [], enemyLasers = [], explosions = [];
let lastFireTime = 0, targetX = 180, targetY = 500;
let recordScore = localStorage.getItem('recordVortexPoints') || 0;

const player = { x: 180, y: 500, w: 42, h: 68, active: true, lerp: 0.18 };

function createParticles() {
    particles = [];
    for (let i = 0; i < 40; i++) {
        particles.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, length: Math.random() * 25 + 5, speed: (Math.random() * 7 + 3) });
    }
}

function emitExplosion(x, y, colors, count, power) {
    for (let i = 0; i < count; i++) {
        explosions.push({ x: x, y: y, vx: (Math.random() - 0.5) * power, vy: (Math.random() - 0.5) * power, color: colors[Math.floor(Math.random() * colors.length)], size: Math.random() * 4 + 1, life: 1.0, decay: Math.random() * 0.04 + 0.02 });
    }
}

function spawnDalek(index = 0) {
    let pool = [];
    
    if (meters <= 500) {
        pool = ['gray', 'red'];
    } else if (meters > 500 && meters <= 1000) {
        pool = ['blue'];
    } else if (meters > 1000 && meters <= 1500) {
        pool = ['yellow'];
    } else if (meters > 1500 && meters <= 2000) {
        pool = ['purple'];
    } else {
        pool = ['gray', 'red', 'blue', 'yellow', 'purple'];
    }

    let type = pool[Math.floor(Math.random() * pool.length)];
    let health = 1, speedBase = (Math.random() * 1.0 + 2.2), pts = 1, pColor = '#aaa';

    if (type === 'red') { health = 2; pts = 2; pColor = '#f00'; }
    else if (type === 'blue') { health = 1; pts = 3; pColor = '#05f'; }
    else if (type === 'yellow') { health = 1; speedBase += 2.5; pts = 4; pColor = '#ff0'; }
    else if (type === 'purple') { health = 2; pts = 5; pColor = '#a0f'; }

    let safeX = Math.max(5, Math.min(canvas.width - 49, Math.random() * (canvas.width - 50)));
    return { x: safeX, y: -150 - (index * 250), speed: speedBase, w: 44, h: 65, type: type, health: health, lastShotTime: 0, value: pts, pColor: pColor };
}

function initGame() {
    exterminatedCount = 0; totalPoints = 0; 
    difficulty = 1.0 + (meters / 1000);
    daleks = []; lasers = []; enemyLasers = []; explosions = [];
    player.active = true;
    for (let i = 0; i < 4; i++) daleks.push(spawnDalek(i));
    createParticles();
}

function drawTardis(x, y) {
    if(!player.active && gameState !== MENU) return;
    const w = player.w, h = player.h;
    ctx.fillStyle = '#ffffff'; ctx.shadowBlur = 15; ctx.shadowColor = '#ffffff';
    ctx.fillRect(x + (w / 2) - 3, y - 6, 6, 6); ctx.shadowBlur = 0; 
    ctx.fillStyle = '#002b5c'; ctx.fillRect(x, y, w, h);
    ctx.fillStyle = '#003b7a'; ctx.fillRect(x + 2, y, 6, h); ctx.fillRect(x + w - 8, y, 6, h);
    ctx.fillStyle = '#000000'; ctx.fillRect(x + 2, y + 4, w - 4, 9);
    ctx.fillStyle = '#ffffff'; ctx.textAlign = 'center'; ctx.font = 'bold 5px Courier New'; 
    ctx.fillText('POLICE BOX', x + w/2, y + 10.5);
    ctx.fillStyle = '#ffffff'; ctx.fillRect(x + 10, y + 16, 9, 10); ctx.fillRect(x + 23, y + 16, 9, 10);
    ctx.fillStyle = '#add8e6';
    for(let r=0; r<3; r++) for(let c=0; c<2; c++) {
        ctx.fillRect(x+11+c*4, y+17+r*3, 3, 2);
        ctx.fillRect(x+24+c*4, y+17+r*3, 3, 2);
    }
}

function drawDalek(d) {
    const x = d.x, y = d.y, w = 44, h = 65;
    let cm = '#666', cd = '#777';
    if (d.type === 'red') { cm = '#b00'; cd = '#d00'; }
    else if (d.type === 'yellow') { cm = '#cc0'; cd = '#ee0'; }
    else if (d.type === 'purple') { cm = '#60a'; cd = '#80c'; }
    else if (d.type === 'blue') { cm = '#004488'; cd = '#0055aa'; }
    ctx.fillStyle = cm; ctx.beginPath(); 
    ctx.moveTo(x + 2, y + h); ctx.lineTo(x + w - 2, y + h); 
    ctx.lineTo(x + w - 8, y + 30); ctx.lineTo(x + 8, y + 30); ctx.fill();
    for (let r=0; r<4; r++) for (let c=0; c<3; c++) {
        ctx.fillStyle = '#333'; ctx.beginPath(); ctx.arc(x + 12 + c*10, y + 36 + r*7, 3, 0, Math.PI*2); ctx.fill();
    }
    ctx.fillStyle = cd; ctx.beginPath(); ctx.arc(x + 22, y + 20, 11, Math.PI, 0); ctx.fill();
    ctx.fillStyle = '#00d2ff'; ctx.beginPath(); ctx.arc(x + 22, y + 12, 3, 0, Math.PI*2); ctx.fill();
}

function toggleFullscreen() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {});
    }
}

function handleInput(e) {
    // RESOLUÇÃO DO ÁUDIO: Toca um som mudo ou inicia o contexto no primeiro toque
    if (bgMusic.paused) {
        bgMusic.play().catch(err => console.log("Aguardando interação..."));
    }

    toggleFullscreen();
    const rect = canvas.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    const canvasX = (clientX - rect.left) * (canvas.width / rect.width);
    const canvasY = (clientY - rect.top) * (canvas.height / rect.height);

    if (gameState === PLAYING && canvasX > canvas.width - 60 && canvasY < 60) {
        gameState = PAUSED; bgMusic.volume = 0.1; return;
    } else if (gameState === PAUSED) {
        gameState = PLAYING; bgMusic.volume = 0.3; bgMusic.play(); return;
    }

    if (canvasX < 60 && canvasY > canvas.height - 60) {
        let skip = prompt("Pular para quantos metros?");
        if (skip !== null) { 
            meters = parseInt(skip) || 0; 
            initGame(); 
            gameState = PLAYING; 
            bgMusic.play().catch(() => {});
        }
        return;
    }

    if (gameState === MENU) { meters = 0; initGame(); gameState = PLAYING; bgMusic.play().catch(() => {}); return; }
    if (gameState === GAMEOVER) { gameState = MENU; return; }
}

function updateMousePos(e) {
    const rect = canvas.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    targetX = (clientX - rect.left) * (canvas.width / rect.width) - player.w / 2;
    targetY = (clientY - rect.top) * (canvas.height / rect.height) - player.h / 1.5;
}

window.addEventListener('mousedown', handleInput);
window.addEventListener('touchstart', (e) => { e.preventDefault(); handleInput(e); }, {passive: false});
window.addEventListener('mousemove', updateMousePos);
window.addEventListener('touchmove', (e) => { e.preventDefault(); updateMousePos(e); }, {passive: false});

function update() {
    ctx.fillStyle = '#000510'; ctx.fillRect(0, 0, canvas.width, canvas.height);
    const now = Date.now();

    ctx.strokeStyle = '#1e3799'; ctx.lineWidth = 2;
    particles.forEach(p => {
        p.y += p.speed * (gameState === PLAYING ? (difficulty * 0.8) : 0.5);
        if (p.y > canvas.height) p.y = -50;
        ctx.beginPath(); ctx.moveTo(p.x, p.y); ctx.lineTo(p.x, p.y + p.length); ctx.stroke();
    });

    if (gameState === PLAYING) {
        meters += 0.1;
        difficulty = 1.0 + (meters / 1000);

        player.x += (targetX - player.x) * player.lerp;
        player.y += (targetY - player.y) * player.lerp;
        player.x = Math.max(0, Math.min(canvas.width - player.w, player.x));

        if (now - lastFireTime > 220) { lasers.push({ x: player.x + 20, y: player.y }); lastFireTime = now; }
        ctx.fillStyle = '#00ffff';
        lasers.forEach((l, i) => { l.y -= 12; ctx.fillRect(l.x, l.y, 3, 15); if (l.y < -20) lasers.splice(i, 1); });

        daleks.forEach((d, dIdx) => {
            d.y += d.speed * difficulty; 
            drawDalek(d);
            
            if (d.y > 0 && d.y < 550 && now - d.lastShotTime > 2000 / difficulty) {
                if (d.type === 'blue' || d.type === 'yellow') {
                    enemyLasers.push({ x: d.x + 22, y: d.y + 50, vx: 0, vy: (6 * difficulty), w: 4, h: 12 });
                } else if (d.type === 'purple') {
                    enemyLasers.push({ x: d.x - 10, y: d.y + 30, vx: (-5 * difficulty), vy: 0, w: 12, h: 4 });
                    enemyLasers.push({ x: d.x + 50, y: d.y + 30, vx: (5 * difficulty), vy: 0, w: 12, h: 4 });
                }
                d.lastShotTime = now;
            }
            lasers.forEach((l, lIdx) => {
                if (l.x > d.x && l.x < d.x + d.w && l.y > d.y && l.y < d.y + d.h) {
                    d.health--; lasers.splice(lIdx, 1);
                    if (d.health <= 0) { 
                        emitExplosion(d.x+22, d.y+30, [d.pColor, '#fff', '#333'], 15, 7); 
                        totalPoints += d.value;
                        exterminatedCount++; 
                        daleks[dIdx] = spawnDalek(dIdx); 
                    }
                }
            });
            if (d.y > canvas.height) daleks[dIdx] = spawnDalek(dIdx);
            if (player.active && checkCollision(player, d)) killPlayer();
        });

        ctx.fillStyle = '#ff3333';
        enemyLasers.forEach((el, i) => {
            el.y += el.vy; el.x += el.vx; ctx.fillRect(el.x, el.y, el.w, el.h);
            if (el.y > canvas.height || el.x < -20 || el.x > canvas.width + 20) enemyLasers.splice(i, 1);
            if (player.active && checkCollision(player, el)) killPlayer();
        });

        drawTardis(player.x, player.y); drawUI();
        ctx.fillStyle = '#fff'; ctx.fillRect(canvas.width - 40, 20, 10, 30); ctx.fillRect(canvas.width - 25, 20, 10, 30);

    } else if (gameState === PAUSED) {
        drawTardis(player.x, player.y);
        drawOverlay("PAUSADO", "TOQUE PARA RETOMAR");
    } else if (gameState === MENU) {
        const flyX = 180 + Math.sin(now / 1000) * 30, flyY = 350 + Math.cos(now / 1500) * 20;
        drawTardis(flyX, flyY);
        drawOverlay("VORTEX TEMPORAL", "TOQUE PARA INICIAR");
    } else if (gameState === GAMEOVER) {
        drawGameOver();
    }

    explosions.forEach((p, i) => {
        ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); ctx.fill();
        p.x += p.vx; p.y += p.vy; p.life -= p.decay; if (p.life <= 0) explosions.splice(i, 1);
    });
    ctx.globalAlpha = 1.0; requestAnimationFrame(update);
}

function checkCollision(r1, r2) {
    const w2 = r2.w || 4, h2 = r2.h || 12;
    return r1.x < r2.x + w2 && r1.x + r1.w > r2.x && r1.y < r2.y + h2 && r1.y + r1.h > r2.y;
}

function killPlayer() {
    if (!player.active) return;
    player.active = false;
    explosionSound.play();
    emitExplosion(player.x + 20, player.y + 32, ['#fff', '#00ffff', '#ffd700'], 40, 10);
    if (totalPoints > recordScore) { recordScore = totalPoints; localStorage.setItem('recordVortexPoints', recordScore); }
    setTimeout(() => gameState = GAMEOVER, 400);
}

function drawUI() {
    ctx.fillStyle = '#50fa7b'; ctx.font = 'bold 16px Courier New'; ctx.textAlign = 'left';
    ctx.fillText(`PONTOS: ${totalPoints}`, 20, 40);
    ctx.fillText(`METROS: ${Math.floor(meters)}`, 20, 65);
}

function drawOverlay(t, s) {
    ctx.fillStyle = 'rgba(0, 5, 16, 0.4)'; ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.textAlign = 'center'; ctx.fillStyle = '#00ffff'; ctx.font = 'bold 30px Courier New';
    ctx.fillText(t, 200, 200); ctx.fillStyle = '#fff'; ctx.font = '16px Courier New'; ctx.fillText(s, 200, 250);
}

function drawGameOver() {
    ctx.fillStyle = 'rgba(0, 5, 16, 0.8)'; ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.textAlign = 'center';
    ctx.fillStyle = '#ff3333'; ctx.font = 'bold 36px Courier New';
    ctx.fillText("EXTERMINADO!", 200, 200);
    ctx.fillStyle = '#fff'; ctx.font = '20px Courier New';
    ctx.fillText(`Pontos: ${totalPoints}`, 200, 280);
    ctx.fillStyle = '#50fa7b';
    ctx.fillText(`RECORD: ${recordScore}`, 200, 320);
    ctx.fillStyle = '#aaa'; ctx.font = '14px Courier New';
    ctx.fillText("TOQUE PARA VOLTAR AO MENU", 200, 400);
}

createParticles(); update();
</script>
</body>
</html>
